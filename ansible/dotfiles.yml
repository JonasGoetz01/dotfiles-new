---
- name: Playbook to manage elnappos dotfiles (https://github.com/elnappo/dotfiles)
  hosts: localhost
  connection: local
  tasks:
    - name: load custom vars
      include_vars: ../vars.yml
      tags:
        - always

    - name: make sure dotfiles are present
      git: repo=https://github.com/elnappo/dotfiles.git dest=~/.dotfiles

    - name: allow sudo without password
      lineinfile: 'dest=/etc/sudoers state=present line="{{ ansible_user_id }}	ALL=NOPASSWD: ALL" insertafter="^%admin\tALL=\(ALL\) ALL" validate="visudo -cf %s"'
      become: yes
      when: sudo_without_password

    - name: enable tty_tickets
      lineinfile: 'dest=/etc/sudoers state=present line="Defaults tty_tickets" validate="visudo -cf %s"'
      become: yes

    - name: install oh-my-zsh
      git: repo=https://github.com/robbyrussell/oh-my-zsh.git dest=~/.local/share/oh-my-zsh update=yes

    - name: install oh-my-fish
      git: repo=https://github.com/oh-my-fish/oh-my-fish.git dest=~/.local/share/omf update=yes

    - name: install Tmux Plugin Manager
      git: repo=https://github.com/tmux-plugins/tpm.git dest=~/.local/share/tpm update=yes

    - name: install neobundle
      git: repo=https://github.com/Shougo/neobundle.vim.git dest=~/.local/share/neobundle update=yes

    - name: Create folder
      file: path={{item}} state=directory
      with_items:
        - "~/.local/share/zsh/"
        - "~/.local/share/bash/"
        - "~/.config/fish/"
        - "~/.config/omf/"
        - "~/.config/i3/"
        - "~/.config/gtk-3.0"
        - "~/.cache/vim/"
        - "~/Coding/"

    - include: tasks/link_files.yml
      tags:
        - links

    - include: tasks/packages.yml
      tags:
        - packages

    # Needs to be after packages
    - include: tasks/tmux_plugins.yml
      tags:
        - tmux_plugins

    - include: tasks/shells.yml
      tags:
        - shells

    - include: tasks/macos_defaults.yml
      when: ansible_os_family == "Darwin"
      tags:
        - macos_defaults
    
    - include: tasks/arch.yml
      when: ansible_os_family == "Archlinux"
      tags:
        - arch

    - include: tasks/dnscrypt.yml
      when: use_dnscrypt and ansible_os_family == "Darwin"
      tags:
        - dnscrypt

  handlers:
    - name: kill Dock
      command: killall Dock

    - name: kill Finder
      command: killall Finder

    - name: kill Transmission
      command: killall Transmission 
      ignore_errors: yes

    - name: kill Safari
      command: killall Safari 
      ignore_errors: yes

    - name: kill Terminal
      command: killall Terminal 
      ignore_errors: yes
